name: Build EliAI IPA

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    name: Build and Package IPA
    runs-on: macos-15

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Select Xcode Version
      run: sudo xcode-select -s /Applications/Xcode_16.app

    - name: Set up Local Packages
      run: |
        # Install and configure LFS
        brew install git-lfs
        git lfs install
        
        mkdir -p Packages
        git clone https://github.com/eastriverlee/LLM.swift.git Packages/LLM
        cd Packages/LLM
        git lfs pull
        
        echo "--- Verifying LFS content ---"
        ls -R llama.cpp
        
        # Use base64 to avoid any indentation or shell parsing issues with SwiftPM manifest
        # This content corresponds to the robust Package.swift with swift-tools-version: 5.9
        echo "Ly8gc3dpZnQtdG9vbHMtdmVyc2lvbjogNS45DQppbXBvcnQgUGFja2FnZURlc2Ny" > Package.b64
        echo "aXB0aW9uDQoNCmxldCBwYWNrYWdlID0gUGFja2FnZSgNCiAgICBuYW1lOiAiTExN" >> Package.b64
        echo "IiwNCiAgICBwbGF0Zm9ybXM6IFsubWFjT1MoLnYxMyksIC5pT1MoLnYxNildLA0K" >> Package.b64
        echo "ICAgIHByb2R1Y3RzOiBbDQogICAgICAgIC5saWJyYXJ5KG5hbWU6ICJMTE0iLCB0" >> Package.b64
        echo "YXJnZXRzOiBbIkxMTSJdKSwNCiAgICBdLA0KICAgIGRlcGVuZGVuY2llczogWw0K" >> Package.b64
        echo "ICAgICAgICAucGFja2FnZSh1cmw6ICJodHRwczovL2dpdGh1Yi5jb20vYXBwbGUv" >> Package.b64
        echo "c3dpZnQtc3ludGF4LmdpdCIsIGZyb206ICI2MDAuMC4xIiksDQogICAgXSwNCiAg" >> Package.b64
        echo "ICB0YXJnZXRzOiBbDQogICAgICAgIC50YXJnZXQoDQogICAgICAgICAgICBuYW1l" >> Package.b64
        echo "OiAiTExNIiwNCiAgICAgICAgICAgIGRlcGVuZGVuY2llczogWw0KICAgICAgICAg" >> Package.b64
        echo "ICAgICAgICJsbG0iLA0KICAgICAgICAgICAgICAgICJMTE1NYWNyb3NJbXBsZW1l" >> Package.b64
        echo "bnRhdGlvbiIsDQogICAgICAgICAgICBdLA0KICAgICAgICAgICAgcGF0aDogIlNv" >> Package.b64
        echo "dXJjZXMvTExNIg0KICAgICAgICApLA0KICAgICAgICAuYmluYXJ5VGFyZ2V0KA0K" >> Package.b64
        echo "ICAgICAgICAgICAgbmFtZTogImxsbSIsDQogICAgICAgICAgICBwYXRoOiAibGxh" >> Package.b64
        echo "bWEuY3BwL2xsYW1hLnhjZnJhbWV3b3JrIg0KICAgICAgICApLA0KICAgICAgICAu" >> Package.b64
        echo "bWFjcm8oDQogICAgICAgICAgICBuYW1lOiAiTExNTWFjcm9zSW1wbGVtZW50YXRp" >> Package.b64
        echo "b24iLA0KICAgICAgICAgICAgZGVwZW5kZW5jaWVzOiBbDQogICAgICAgICAgICAg" >> Package.b64
        echo "ICAgLnByb2R1Y3QobmFtZTogIlN3aWZ0U3ludGF4TWFjcm9zIiwgcGFja2FnZTog" >> Package.b64
        echo "InN3aWZ0LXN5bnRheCIpLA0KICAgICAgICAgICAgICAgIC5wcm9kdWN0KG5hbWU6" >> Package.b64
        echo "ICJTd2lmdENvbXBpbGVyUGx1Z2luIiwgcGFja2FnZTogInN3aWZ0LXN5bnRheCIp" >> Package.b64
        echo "DQogICAgICAgICAgICBdDQogICAgICAgICkNCiAgICBdDQopDQo=" >> Package.b64
        
        base64 -d -i Package.b64 > Package.swift
        
        echo "--- New Package.swift Content ---"
        cat Package.swift

    - name: Set up Swift
      uses: swift-actions/setup-swift@v2
      with:
        swift-version: "6.0.3"

    - name: Verify Swift Version
      run: swift --version

    - name: Update Dependencies
      run: swift package update

    - name: Install XcodeGen
      run: brew install xcodegen

    - name: Generate Xcode Project
      run: xcodegen generate

    - name: Resolve Dependencies
      run: xcodebuild -resolvePackageDependencies -project EliAI.xcodeproj -scheme EliAI -skipPackagePluginValidation

    - name: Build App
      # Build the generated project
      run: |
        xcodebuild build \
          -project EliAI.xcodeproj \
          -scheme EliAI \
          -sdk iphoneos \
          -configuration Release \
          -derivedDataPath build \
          -skipPackagePluginValidation \
          -skipMacroValidation \
          IDEPackageEnablePrebuilts=YES \
          OTHER_SWIFT_FLAGS="$(inherited) -enable-experimental-feature Macros" \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO

    - name: Package IPA
      # Manually create the Payload structure for an unsigned IPA
      run: |
        mkdir Payload
        cp -r build/Build/Products/Release-iphoneos/EliAI.app Payload/
        zip -r EliAI.ipa Payload

    - name: Upload IPA Artifact
      uses: actions/upload-artifact@v4
      with:
        name: EliAI-IPA
        path: EliAI.ipa
