name: Build EliAI IPA

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    name: Build, Test, and Package IPA
    runs-on: macos-15

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set Up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "16.2"

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Xcode Project
        run: xcodegen generate

      - name: Resolve Package Dependencies
        run: |
          xcodebuild -resolvePackageDependencies \
            -project EliAI.xcodeproj \
            -scheme EliAI \
            -skipPackagePluginValidation \
            -clonedSourcePackagesDirPath .spm

      - name: Select Simulator
        id: sim
        run: |
          SIM_ID=$(xcrun simctl list devices available | awk -F '[()]' '/iPhone/ && !/unavailable/ {print $2; exit}')
          if [ -z "$SIM_ID" ]; then
            echo "No available iPhone simulator found."
            exit 1
          fi
          echo "Using simulator id: $SIM_ID"
          echo "sim_id=$SIM_ID" >> "$GITHUB_OUTPUT"

      - name: Build For Testing (Simulator Smoke)
        run: |
          xcodebuild build-for-testing \
            -project EliAI.xcodeproj \
            -scheme EliAI \
            -destination "id=${{ steps.sim.outputs.sim_id }}" \
            -derivedDataPath build \
            -clonedSourcePackagesDirPath .spm \
            -skipPackagePluginValidation \
            -skipMacroValidation

      - name: Launch Smoke Test
        run: |
          xcodebuild test \
            -project EliAI.xcodeproj \
            -scheme EliAI \
            -destination "id=${{ steps.sim.outputs.sim_id }}" \
            -derivedDataPath build \
            -clonedSourcePackagesDirPath .spm \
            -skipPackagePluginValidation \
            -skipMacroValidation \
            -only-testing:EliAIUITests/EliAIUITests/testAppLaunchesWithoutModel

      - name: Model Load Smoke Test
        run: |
          xcodebuild test \
            -project EliAI.xcodeproj \
            -scheme EliAI \
            -destination "id=${{ steps.sim.outputs.sim_id }}" \
            -derivedDataPath build \
            -clonedSourcePackagesDirPath .spm \
            -skipPackagePluginValidation \
            -skipMacroValidation \
            -only-testing:EliAITests/ModelValidatorTests

      - name: Build Release App (Device)
        run: |
          xcodebuild build \
            -project EliAI.xcodeproj \
            -scheme EliAI \
            -destination 'generic/platform=iOS' \
            -configuration Release \
            -derivedDataPath build \
            -clonedSourcePackagesDirPath .spm \
            -skipPackagePluginValidation \
            -skipMacroValidation \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Package IPA
        run: |
          mkdir -p Payload
          cp -r build/Build/Products/Release-iphoneos/EliAI.app Payload/
          /usr/bin/zip -r EliAI.ipa Payload

      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: EliAI-IPA
          path: EliAI.ipa
